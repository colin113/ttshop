import{N as le,R as ee,T as ne,U as Oe,r as A,aa as K,V as E,W as ze,aq as ie,g as i,an as _,Q as oe,Z as ae,ag as Y,aF as Te,L as ge,ac as fe,bK as pe,ao as T,bq as he,O as M,a8 as re,az as V,q as De,b8 as Ue,b9 as Fe,X as we,as as se,ar as H,P as Le,bd as Ae,I as W,av as be,b6 as Xe,am as J,bL as Be,bM as Ye,$ as ye,bl as Ce,bi as Ze,af as Ie,at as Me,aO as Ve,a7 as Ee,aC as ce,aD as ue,bh as $e}from"./index-BvrlI3rd.js";import{a as Ne,S as je}from"./index-tn7Hb5pv.js";import{I as Pe}from"./index-CqHXZlWv.js";const de=e=>Math.sqrt((e[0].clientX-e[1].clientX)**2+(e[0].clientY-e[1].clientY)**2),_e=e=>({x:(e[0].clientX+e[1].clientX)/2,y:(e[0].clientY+e[1].clientY)/2}),te=le("image-preview")[1],ve=2.6,He={src:String,show:Boolean,active:Number,minZoom:_(oe),maxZoom:_(oe),rootWidth:_(Number),rootHeight:_(Number),disableZoom:Boolean,doubleScale:Boolean,closeOnClickImage:Boolean,closeOnClickOverlay:Boolean,vertical:Boolean};var We=ee({props:He,emits:["scale","close","longPress"],setup(e,{emit:l,slots:c}){const a=ne({scale:1,moveX:0,moveY:0,moving:!1,zooming:!1,initializing:!1,imageRatio:0}),m=Oe(),u=A(),x=A(),C=A(!1),y=A(!1);let R=0;const s=K(()=>{const{scale:t,moveX:n,moveY:d,moving:P,zooming:z,initializing:L}=a,G={transitionDuration:z||P||L?"0s":".3s"};return(t!==1||y.value)&&(G.transform=`matrix(${t}, 0, 0, ${t}, ${n}, ${d})`),G}),g=K(()=>{if(a.imageRatio){const{rootWidth:t,rootHeight:n}=e,d=C.value?n/a.imageRatio:t;return Math.max(0,(a.scale*d-t)/2)}return 0}),f=K(()=>{if(a.imageRatio){const{rootWidth:t,rootHeight:n}=e,d=C.value?n:t*a.imageRatio;return Math.max(0,(a.scale*d-n)/2)}return 0}),h=(t,n)=>{var d;if(t=Y(t,+e.minZoom,+e.maxZoom+1),t!==a.scale){const P=t/a.scale;if(a.scale=t,n){const z=fe((d=u.value)==null?void 0:d.$el),L={x:z.width*.5,y:z.height*.5},G=a.moveX-(n.x-z.left-L.x)*(P-1),Re=a.moveY-(n.y-z.top-L.y)*(P-1);a.moveX=Y(G,-g.value,g.value),a.moveY=Y(Re,-f.value,f.value)}else a.moveX=0,a.moveY=y.value?R:0;l("scale",{scale:t,index:e.active})}},k=()=>{h(1)},$=()=>{const t=a.scale>1?1:2;h(t,t===2||y.value?{x:m.startX.value,y:m.startY.value}:void 0)};let U,X,F,v,O,S,B,N,o=!1;const r=t=>{const{touches:n}=t;if(U=n.length,U===2&&e.disableZoom)return;const{offsetX:d}=m;m.start(t),X=a.moveX,F=a.moveY,N=Date.now(),o=!1,a.moving=U===1&&(a.scale!==1||y.value),a.zooming=U===2&&!d.value,a.zooming&&(v=a.scale,O=de(n))},I=t=>{const{touches:n}=t;if(m.move(t),a.moving){const{deltaX:d,deltaY:P}=m,z=d.value+X,L=P.value+F;if((e.vertical?m.isVertical()&&Math.abs(L)>f.value:m.isHorizontal()&&Math.abs(z)>g.value)&&!o){a.moving=!1;return}o=!0,ae(t,!0),a.moveX=Y(z,-g.value,g.value),a.moveY=Y(L,-f.value,f.value)}if(a.zooming&&(ae(t,!0),n.length===2)){const d=de(n),P=v*d/O;S=_e(n),h(P,S)}},w=t=>{var n;const d=(n=x.value)==null?void 0:n.$el,P=d.firstElementChild,z=t.target===d,L=P==null?void 0:P.contains(t.target);!e.closeOnClickImage&&L||!e.closeOnClickOverlay&&z||l("close")},p=t=>{if(U>1)return;const n=Date.now()-N,d=250;m.isTap.value&&(n<d?e.doubleScale?B?(clearTimeout(B),B=null,$()):B=setTimeout(()=>{w(t),B=null},d):w(t):n>pe&&l("longPress"))},D=t=>{let n=!1;if((a.moving||a.zooming)&&(n=!0,a.moving&&X===a.moveX&&F===a.moveY&&(n=!1),!t.touches.length)){a.zooming&&(a.moveX=Y(a.moveX,-g.value,g.value),a.moveY=Y(a.moveY,-f.value,f.value),a.zooming=!1),a.moving=!1,X=0,F=0,v=1,a.scale<1&&k();const d=+e.maxZoom;a.scale>d&&h(d,S)}ae(t,n),p(t),m.reset()},q=()=>{const{rootWidth:t,rootHeight:n}=e,d=n/t,{imageRatio:P}=a;C.value=a.imageRatio>d&&P<ve,y.value=a.imageRatio>d&&P>=ve,y.value&&(R=(P*t-n)/2,a.moveY=R,a.initializing=!0,Te(()=>{a.initializing=!1})),k()},j=t=>{const{naturalWidth:n,naturalHeight:d}=t.target;a.imageRatio=d/n,q()};return E(()=>e.active,k),E(()=>e.show,t=>{t||k()}),E(()=>[e.rootWidth,e.rootHeight],q),ze("touchmove",I,{target:K(()=>{var t;return(t=x.value)==null?void 0:t.$el})}),ie({resetScale:k}),()=>{const t={loading:()=>i(ge,{type:"spinner"},null)};return i(Ne,{ref:x,class:te("swipe-item"),onTouchstartPassive:r,onTouchend:D,onTouchcancel:D},{default:()=>[c.image?i("div",{class:te("image-wrap")},[c.image({src:e.src,onLoad:j,style:s.value})]):i(Pe,{ref:u,src:e.src,fit:"contain",class:te("image",{vertical:C.value}),style:s.value,onLoad:j},t)]})}}});const[qe,Z]=le("image-preview"),Ge=["show","teleport","transition","overlayStyle","closeOnPopstate"],Ke={show:Boolean,loop:T,images:he(),minZoom:M(1/3),maxZoom:M(3),overlay:T,vertical:Boolean,closeable:Boolean,showIndex:T,className:re,closeIcon:V("clear"),transition:String,beforeClose:Function,doubleScale:T,overlayClass:re,overlayStyle:Object,swipeDuration:M(300),startPosition:M(0),showIndicators:Boolean,closeOnPopstate:T,closeOnClickImage:T,closeOnClickOverlay:T,closeIconPosition:V("top-right"),teleport:[String,Object]};var Se=ee({name:qe,props:Ke,emits:["scale","close","closed","change","longPress","update:show"],setup(e,{emit:l,slots:c}){const a=A(),m=A(),u=ne({active:0,rootWidth:0,rootHeight:0,disableZoom:!1}),x=()=>{if(a.value){const v=fe(a.value.$el);u.rootWidth=v.width,u.rootHeight=v.height,a.value.resize()}},C=v=>l("scale",v),y=v=>l("update:show",v),R=()=>{be(e.beforeClose,{args:[u.active],done:()=>y(!1)})},s=v=>{v!==u.active&&(u.active=v,l("change",v))},g=()=>{if(e.showIndex)return i("div",{class:Z("index")},[c.index?c.index({index:u.active}):`${u.active+1} / ${e.images.length}`])},f=()=>{if(c.cover)return i("div",{class:Z("cover")},[c.cover()])},h=()=>{u.disableZoom=!0},k=()=>{u.disableZoom=!1},$=()=>i(je,{ref:a,lazyRender:!0,loop:e.loop,class:Z("swipe"),vertical:e.vertical,duration:e.swipeDuration,initialSwipe:e.startPosition,showIndicators:e.showIndicators,indicatorColor:"white",onChange:s,onDragEnd:k,onDragStart:h},{default:()=>[e.images.map((v,O)=>i(We,{ref:S=>{O===u.active&&(m.value=S)},src:v,show:e.show,active:u.active,maxZoom:e.maxZoom,minZoom:e.minZoom,rootWidth:u.rootWidth,rootHeight:u.rootHeight,disableZoom:u.disableZoom,doubleScale:e.doubleScale,closeOnClickImage:e.closeOnClickImage,closeOnClickOverlay:e.closeOnClickOverlay,vertical:e.vertical,onScale:C,onClose:R,onLongPress:()=>l("longPress",{index:O})},{image:c.image}))]}),U=()=>{if(e.closeable)return i(W,{role:"button",name:e.closeIcon,class:[Z("close-icon",e.closeIconPosition),Ae],onClick:R},null)},X=()=>l("closed"),F=(v,O)=>{var S;return(S=a.value)==null?void 0:S.swipeTo(v,O)};return ie({resetScale:()=>{var v;(v=m.value)==null||v.resetScale()},swipeTo:F}),De(x),E([Ue,Fe],x),E(()=>e.startPosition,v=>s(+v)),E(()=>e.show,v=>{const{images:O,startPosition:S}=e;v?(s(+S),we(()=>{x(),F(+S,{immediate:!0})})):l("close",{index:u.active,url:O[u.active]})}),()=>i(Le,se({class:[Z(),e.className],overlayClass:[Z("overlay"),e.overlayClass],onClosed:X,"onUpdate:show":y},H(e,Ge)),{default:()=>[U(),$(),g(),f()]})}});let Q;const Qe={loop:!0,images:[],maxZoom:3,minZoom:1/3,onScale:void 0,onClose:void 0,onChange:void 0,vertical:!1,teleport:"body",className:"",showIndex:!0,closeable:!1,closeIcon:"clear",transition:void 0,beforeClose:void 0,doubleScale:!0,overlayStyle:void 0,overlayClass:void 0,startPosition:0,swipeDuration:300,showIndicators:!1,closeOnPopstate:!0,closeOnClickOverlay:!0,closeIconPosition:"top-right"};function Je(){({instance:Q}=Be({setup(){const{state:e,toggle:l}=Ye(),c=()=>{e.images=[]};return()=>i(Se,se(e,{onClosed:c,"onUpdate:show":l}),null)}}))}const ea=(e,l=0)=>{if(Xe)return Q||Je(),e=Array.isArray(e)?{images:e,startPosition:l}:e,Q.open(J({},Qe,e)),Q};ye(Se);const[aa,b,ta]=le("uploader");function me(e,l){return new Promise(c=>{if(l==="file"){c();return}const a=new FileReader;a.onload=m=>{c(m.target.result)},l==="dataUrl"?a.readAsDataURL(e):l==="text"&&a.readAsText(e)})}function xe(e,l){return Ce(e).some(c=>c.file?Ze(l)?l(c.file):c.file.size>+l:!1)}function oa(e,l){const c=[],a=[];return e.forEach(m=>{xe(m,l)?a.push(m):c.push(m)}),{valid:c,invalid:a}}const la=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i,na=e=>la.test(e);function ke(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?na(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var ia=ee({props:{name:oe,item:_(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,reupload:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview","reupload"],setup(e,{emit:l,slots:c}){const a=()=>{const{status:s,message:g}=e.item;if(s==="uploading"||s==="failed"){const f=s==="failed"?i(W,{name:"close",class:b("mask-icon")},null):i(ge,{class:b("loading")},null),h=Me(g)&&g!=="";return i("div",{class:b("mask")},[f,h&&i("div",{class:b("mask-message")},[g])])}},m=s=>{const{name:g,item:f,index:h,beforeDelete:k}=e;s.stopPropagation(),be(k,{args:[f,{name:g,index:h}],done:()=>l("delete")})},u=()=>l("preview"),x=()=>l("reupload"),C=()=>{if(e.deletable&&e.item.status!=="uploading"){const s=c["preview-delete"];return i("div",{role:"button",class:b("preview-delete",{shadow:!s}),tabindex:0,"aria-label":ta("delete"),onClick:m},[s?s():i(W,{name:"cross",class:b("preview-delete-icon")},null)])}},y=()=>{if(c["preview-cover"]){const{index:s,item:g}=e;return i("div",{class:b("preview-cover")},[c["preview-cover"](J({index:s},g))])}},R=()=>{const{item:s,lazyLoad:g,imageFit:f,previewSize:h,reupload:k}=e;return ke(s)?i(Pe,{fit:f,src:s.objectUrl||s.content||s.url,class:b("preview-image"),width:Array.isArray(h)?h[0]:h,height:Array.isArray(h)?h[1]:h,lazyLoad:g,onClick:k?x:u},{default:y}):i("div",{class:b("file"),style:Ie(e.previewSize)},[i(W,{class:b("file-icon"),name:"description"},null),i("div",{class:[b("file-name"),"van-ellipsis"]},[s.file?s.file.name:s.url]),y()])};return()=>i("div",{class:b("preview")},[R(),a(),C()])}});const sa={name:M(""),accept:V("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:M(1/0),imageFit:V("cover"),resultType:V("dataUrl"),uploadIcon:V("photograph"),uploadText:String,deletable:T,reupload:Boolean,afterRead:Function,showUpload:T,modelValue:he(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:T,previewOptions:Object,previewFullImage:T,maxSize:{type:[Number,String,Function],default:1/0}};var ra=ee({name:aa,props:sa,emits:["delete","oversize","clickUpload","closePreview","clickPreview","clickReupload","update:modelValue"],setup(e,{emit:l,slots:c}){const a=A(),m=[],u=A(-1),x=A(!1),C=(o=e.modelValue.length)=>({name:e.name,index:o}),y=()=>{a.value&&(a.value.value="")},R=o=>{if(y(),xe(o,e.maxSize))if(Array.isArray(o)){const r=oa(o,e.maxSize);if(o=r.valid,l("oversize",r.invalid,C()),!o.length)return}else{l("oversize",o,C());return}if(o=ne(o),u.value>-1){const r=[...e.modelValue];r.splice(u.value,1,o),l("update:modelValue",r),u.value=-1}else l("update:modelValue",[...e.modelValue,...Ce(o)]);e.afterRead&&e.afterRead(o,C())},s=o=>{const{maxCount:r,modelValue:I,resultType:w}=e;if(Array.isArray(o)){const p=+r-I.length;o.length>p&&(o=o.slice(0,p)),Promise.all(o.map(D=>me(D,w))).then(D=>{const q=o.map((j,t)=>{const n={file:j,status:"",message:"",objectUrl:URL.createObjectURL(j)};return D[t]&&(n.content=D[t]),n});R(q)})}else me(o,w).then(p=>{const D={file:o,status:"",message:"",objectUrl:URL.createObjectURL(o)};p&&(D.content=p),R(D)})},g=o=>{const{files:r}=o.target;if(e.disabled||!r||!r.length)return;const I=r.length===1?r[0]:[].slice.call(r);if(e.beforeRead){const w=e.beforeRead(I,C());if(!w){y();return}if($e(w)){w.then(p=>{s(p||I)}).catch(y);return}}s(I)};let f;const h=()=>l("closePreview"),k=o=>{if(e.previewFullImage){const r=e.modelValue.filter(ke),I=r.map(w=>(w.objectUrl&&!w.url&&w.status!=="failed"&&(w.url=w.objectUrl,m.push(w.url)),w.url)).filter(Boolean);f=ea(J({images:I,startPosition:r.indexOf(o),onClose:h},e.previewOptions))}},$=()=>{f&&f.close()},U=(o,r)=>{const I=e.modelValue.slice(0);I.splice(r,1),l("update:modelValue",I),l("delete",o,C(r))},X=o=>{x.value=!0,u.value=o,we(()=>N())},F=()=>{x.value||(u.value=-1),x.value=!1},v=(o,r)=>{const I=["imageFit","deletable","reupload","previewSize","beforeDelete"],w=J(H(e,I),H(o,I,!0));return i(ia,se({item:o,index:r,onClick:()=>l(e.reupload?"clickReupload":"clickPreview",o,C(r)),onDelete:()=>U(o,r),onPreview:()=>k(o),onReupload:()=>X(r)},H(e,["name","lazyLoad"]),w),H(c,["preview-cover","preview-delete"]))},O=()=>{if(e.previewImage)return e.modelValue.map(v)},S=o=>l("clickUpload",o),B=()=>{if(e.modelValue.length>=+e.maxCount&&!e.reupload)return;const o=e.modelValue.length>=+e.maxCount&&e.reupload,r=e.readonly?null:i("input",{ref:a,type:"file",class:b("input"),accept:e.accept,capture:e.capture,multiple:e.multiple&&u.value===-1,disabled:e.disabled,onChange:g,onClick:F},null);return c.default?ce(i("div",{class:b("input-wrapper"),onClick:S},[c.default(),r]),[[ue,!o]]):ce(i("div",{class:b("upload",{readonly:e.readonly}),style:Ie(e.previewSize),onClick:S},[i(W,{name:e.uploadIcon,class:b("upload-icon")},null),e.uploadText&&i("span",{class:b("upload-text")},[e.uploadText]),r]),[[ue,e.showUpload&&!o]])},N=()=>{a.value&&!e.disabled&&a.value.click()};return Ve(()=>{m.forEach(o=>URL.revokeObjectURL(o))}),ie({chooseFile:N,closeImagePreview:$}),Ee(()=>e.modelValue),()=>i("div",{class:b()},[i("div",{class:b("wrapper",{disabled:e.disabled})},[O(),B()])])}});const va=ye(ra);export{va as U,ea as s};
